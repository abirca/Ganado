{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Panel de Control Financiero</h1>
    </div>
</div>

<!-- Resumen General -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Flujo de Caja Neto</h5>
                <h3 class="card-text">${{ flujo_caja_neto|floatformat:0|intcomma }}</h3>
                <p class="card-text small">
                    {% if flujo_caja_neto > 0 %}
                        <i class="fas fa-arrow-up"></i> Positivo
                    {% elif flujo_caja_neto < 0 %}
                        <i class="fas fa-arrow-down"></i> Negativo
                    {% else %}
                        <i class="fas fa-equals"></i> Neutro
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Por Cobrar a Clientes</h5>
                <h3 class="card-text">${{ saldo_total_clientes|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Por Pagar a Proveedores</h5>
                <h3 class="card-text">${{ saldo_total_proveedores|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Total Gastos</h5>
                <h3 class="card-text">${{ total_gastos|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Segunda fila de KPIs -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Ingresos Netos</h5>
                <h3 class="card-text">${{ ingresos_netos|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-purple text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Margen de Beneficio</h5>
                <h3 class="card-text">{{ margen_beneficio|floatformat:2 }}%</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-teal text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Facturación Proveedores</h5>
                <h3 class="card-text">${{ total_facturado_proveedores|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-orange text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Facturación Clientes</h5>
                <h3 class="card-text">${{ total_facturado_clientes|floatformat:0|intcomma }}</h3>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-purple { background-color: #6f42c1 !important; }
    .bg-teal { background-color: #20c9a6 !important; }
    .bg-orange { background-color: #fd7e14 !important; }
</style>

<!-- Tendencias -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Tendencia de Facturación, Abonos y Gastos (Últimos 6 Meses)</h5>
            </div>
            <div class="card-body">
                <canvas id="tendenciaChart" style="height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Distribución de Gastos -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h5>Distribución de Gastos por Categoría</h5>
            </div>
            <div class="card-body">
                <canvas id="gastosChart" style="height: 250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h5>Top 5 Gastos Más Altos</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Categoría</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gasto in top_gastos %}
                            <tr>
                                <td>{{ gasto.fecha|date:"d/m/Y" }}</td>
                                <td>{{ gasto.categoria }}</td>
                                <td>${{ gasto.precio|floatformat:0|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay gastos registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas de Proveedores y Clientes -->
<div class="row mb-4">
    <!-- Proveedores -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5>Estadísticas de Proveedores</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="border rounded p-3 text-center">
                            <h6>Total Facturado</h6>
                            <h4 class="text-primary">${{ total_facturado_proveedores|floatformat:0|intcomma }}</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3 text-center">
                            <h6>Total Abonado</h6>
                            <h4 class="text-success">${{ total_abonado_proveedores|floatformat:0|intcomma }}</h4>
                        </div>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ porcentaje_abono_proveedores }}%;" 
                         aria-valuenow="{{ porcentaje_abono_proveedores }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ porcentaje_abono_proveedores|floatformat:2 }}% Abonado
                    </div>
                </div>
                <h6>Principales Proveedores con Saldo:</h6>
                <ul class="list-group">
                    {% for proveedor in proveedores_con_saldo %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ proveedor.nombre }}
                        <span class="badge bg-warning rounded-pill">${{ proveedor.saldo|floatformat:0|intcomma }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item">No hay proveedores con saldo pendiente</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Clientes -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5>Estadísticas de Clientes</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="border rounded p-3 text-center">
                            <h6>Total Facturado</h6>
                            <h4 class="text-primary">${{ total_facturado_clientes|floatformat:0|intcomma }}</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3 text-center">
                            <h6>Total Abonado</h6>
                            <h4 class="text-success">${{ total_abonado_clientes|floatformat:0|intcomma }}</h4>
                        </div>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ porcentaje_abono_clientes }}%;" 
                         aria-valuenow="{{ porcentaje_abono_clientes }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ porcentaje_abono_clientes|floatformat:2 }}% Abonado
                    </div>
                </div>
                <h6>Principales Clientes con Saldo:</h6>
                <ul class="list-group">
                    {% for cliente in clientes_con_saldo %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ cliente.nombre }}
                        <span class="badge bg-warning rounded-pill">${{ cliente.saldo|floatformat:0|intcomma }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item">No hay clientes con saldo pendiente</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Movimientos Recientes -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Movimientos Recientes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Entidad</th>
                                <th>Tipo</th>
                                <th>Detalle</th>
                                <th>Observación</th>
                                <th class="text-end">Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in movimientos_recientes %}
                            <tr>
                                <td>{{ mov.fecha|date:"d/m/Y" }}</td>
                                <td>{{ mov.entidad }}</td>
                                <td>
                                    <span class="badge {% if mov.tipo == 'Proveedor' %}bg-warning{% elif mov.tipo == 'Cliente' %}bg-info{% else %}bg-danger{% endif %}">
                                        {{ mov.tipo }}
                                    </span>
                                </td>
                                <td>{{ mov.detalle }}</td>
                                <td>{{ mov.observacion }}</td>
                                <td class="text-end {% if mov.total > 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ mov.total|floatformat:0|intcomma }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No hay movimientos recientes</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enlaces rápidos -->
<div class="row">
    <div class="col-md-3 mb-3">
        <a href="{% url 'mi_app:proveedores_dashboard' %}" class="btn btn-primary w-100 py-3">
            <i class="fas fa-truck me-2"></i> Dashboard de Proveedores
        </a>
    </div>
    <div class="col-md-3 mb-3">
        <a href="{% url 'mi_app:clientes_dashboard' %}" class="btn btn-success w-100 py-3">
            <i class="fas fa-users me-2"></i> Dashboard de Clientes
        </a>
    </div>
    <div class="col-md-3 mb-3">
        <a href="{% url 'mi_app:gastos_dashboard' %}" class="btn btn-danger w-100 py-3">
            <i class="fas fa-money-bill me-2"></i> Dashboard de Gastos
        </a>
    </div>
    <div class="col-md-3 mb-3">
        <a href="#" class="btn btn-info w-100 py-3">
            <i class="fas fa-file-export me-2"></i> Generar Reporte
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfica de tendencia
    const mesesTendencia = {{ meses_tendencia|safe }};
    const facturacionTendencia = {{ facturacion_tendencia|safe }};
    const abonosTendencia = {{ abonos_tendencia|safe }};
    const gastosTendencia = {{ gastos_tendencia|safe }};
    
    new Chart(document.getElementById('tendenciaChart'), {
        type: 'line',
        data: {
            labels: mesesTendencia,
            datasets: [
                {
                    label: 'Facturación',
                    data: facturacionTendencia,
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    pointRadius: 3,
                    pointBackgroundColor: '#4e73df',
                    pointBorderColor: '#4e73df',
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: '#4e73df',
                    pointHoverBorderColor: '#4e73df',
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Abonos',
                    data: abonosTendencia,
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.05)',
                    pointRadius: 3,
                    pointBackgroundColor: '#1cc88a',
                    pointBorderColor: '#1cc88a',
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: '#1cc88a',
                    pointHoverBorderColor: '#1cc88a',
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Gastos',
                    data: gastosTendencia,
                    borderColor: '#e74a3b',
                    backgroundColor: 'rgba(231, 74, 59, 0.05)',
                    pointRadius: 3,
                    pointBackgroundColor: '#e74a3b',
                    pointBorderColor: '#e74a3b',
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: '#e74a3b',
                    pointHoverBorderColor: '#e74a3b',
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    ticks: {
                        beginAtZero: true,
                        callback: function(value) {
                            return '$' + value.toLocaleString('es-CO', {minimumFractionDigits: 0});
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '$' + context.raw.toLocaleString('es-CO', {minimumFractionDigits: 0});
                            return label;
                        }
                    }
                }
            }
        }
    });

    // Gráfica de distribución de gastos
    const gastosCategorias = {{ gastos_categorias|safe }};
    const gastosValores = {{ gastos_valores|safe }};
    
    new Chart(document.getElementById('gastosChart'), {
        type: 'pie',
        data: {
            labels: gastosCategorias,
            datasets: [{
                data: gastosValores,
                backgroundColor: ['#e74a3b', '#fd7e14', '#f6c23e', '#1cc88a', '#36b9cc', '#4e73df', '#6f42c1'],
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '$' + context.raw.toLocaleString('es-CO', {minimumFractionDigits: 0});
                            return label;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}