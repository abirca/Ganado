{% extends 'base.html' %}
{% block content %}
{% load form_tags %}
{% load humanize %}
<div class="card shadow border my-4 p-4">
<h3 class="card-title mb-4">Agregar Movimiento</h3>
  <form method="post" action="{% url 'guardar_movimiento_cliente' %}" class="row g-3">
    {% csrf_token %}
    <div class="col-md-4">
      <label for="filtroProveedor" class="form-label">Filtrar movimientos por proveedor:</label>
      <select name="proveedor" id="filtroProveedor" class="form-select">
        <option value="">-- Todos --</option>
        {% for row in resumen %}
          {% with nombre=row.0 %}
            <option value="{{ nombre }}" {% if nombre == proveedor_filtrado %}selected{% endif %}>{{ nombre }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      {{ form.fecha.label_tag }} 
      {{ form.fecha|add_class:"form-control" }}
    </div>

    <div class="col-md-4">
      {{ form.detalle.label_tag }} 
      {{ form.detalle|add_class:"form-select" }}
    </div>

    <div class="col-md-4">
      {{ form.obs.label_tag }} 
      {{ form.obs|add_class:"form-control" }}
    </div>

    <div class="col-md-4">
      {{ form.total.label_tag }}
      <input type="text" name="total" id="id_total" class="form-control" value="{{ form.total.value|default_if_none:'' }}">
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary mt-3">Guardar</button>
    </div>
  </form>
</div>

  <hr>
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Resumen</h5>
        <table class="table table-bordered table-striped table-hover table-sm">
          <thead class="table-dark">
            <tr>
              <th>Proveedor</th>
              <th>Facturas</th>
              <th>Ahorros</th>
              <th>Saldo</th>
            </tr>
          </thead>
          <tbody>
            {% for row in resumen_Filtrado %}
              <tr>
                <td>{{ row.0 }}</td>
                <td>${{ row.1|floatformat:0|intcomma }}</td>
                <td>${{ row.2|floatformat:0|intcomma }}</td>
                <td class="{% if row.3 <= 0 %}text-success{% else %}text-danger{% endif %}">
                  <strong>${{ row.3|floatformat:0|intcomma }}</strong>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center">Sin registros aún</td>
              </tr>
            {% endfor %}
          </tbody>
      </table>    
    </div>
  </div>
  
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Movimientos</h5>
      <table class="table table-striped table-hover table-sm">
        <thead class="table-primary">
          <tr>
            <th>Fecha</th>
            <th>Proveedor</th>
            <th>Detalle</th>
            <th>Observación</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for mov in movimientos %}
            <tr>
              <td>{{ mov.fecha|date:"d/m/Y" }}</td>
              <td>{{ mov.proveedor }}</td>
              <td>{{ mov.detalle }}</td>
              <td>{{ mov.obs }}</td>
              <td>${{ mov.total|floatformat:0|intcomma }}</td>
              <td>
                <a href="{% url 'editar_movimiento_Cliente' mov.id %}" class="btn btn-sm btn-warning">Editar</a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-center">No hay movimientos aún</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  

  <!-- Paginación -->
<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if proveedor_filtrado %}&proveedor={{ proveedor_filtrado }}{% endif %}{% if fecha_filtrada %}&fecha={{ fecha_filtrada }}{% endif %}" aria-label="Anterior">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {% for num in paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% else %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}{% if proveedor_filtrado %}&proveedor={{ proveedor_filtrado }}{% endif %}{% if fecha_filtrada %}&fecha={{ fecha_filtrada }}{% endif %}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if proveedor_filtrado %}&proveedor={{ proveedor_filtrado }}{% endif %}{% if fecha_filtrada %}&fecha={{ fecha_filtrada }}{% endif %}" aria-label="Siguiente">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const filtroProveedor = document.getElementById("filtroProveedor");
      const filtroFecha = document.getElementById("filtroFecha");
  
      filtroProveedor?.addEventListener("change", function() {
        const proveedor = encodeURIComponent(filtroProveedor.value || '');
        const fecha = encodeURIComponent(filtroFecha?.value || '');
        let query = [];
  
        if (proveedor) query.push(`proveedor=${proveedor}`);
        if (fecha) query.push(`fecha=${fecha}`);
  
        const baseUrl = window.location.origin + window.location.pathname;
        window.location.href = query.length ? `${baseUrl}?${query.join('&')}` : baseUrl;
      });
    });
    document.addEventListener('DOMContentLoaded', function () {
    const totalInput = document.getElementById('id_total');

    function formatNumberToPesos(value) {
      value = value.replace(/\D/g, ''); // eliminar todo excepto números
      if (!value) return '';
      return '$' + parseInt(value, 10).toLocaleString('es-CO');
    }

    function cleanPesos(value) {
      return value.replace(/[^\d]/g, ''); // eliminar $ y puntos
    }

    totalInput.addEventListener('input', function () {
      let rawValue = totalInput.value;
      let cursorPos = totalInput.selectionStart;

      const cleanedBefore = cleanPesos(rawValue.substring(0, cursorPos));
      const isFirstChar = cleanedBefore.length === 1 && cleanPesos(rawValue).length === 1;

      const cleaned = cleanPesos(rawValue);
      const formatted = formatNumberToPesos(cleaned);

      totalInput.value = formatted;

      if (isFirstChar) {
        // Primer número → puntero al final
        totalInput.setSelectionRange(formatted.length, formatted.length);
      } else {
        // Calcular nueva posición compensada por puntos de miles y símbolo $
        const newCursorPos = formatted.length - (cleanPesos(formatted).length - cleanedBefore.length);
        totalInput.setSelectionRange(newCursorPos, newCursorPos);
      }
    });

    // Limpiar antes de enviar
    totalInput.form.addEventListener('submit', function () {
      totalInput.value = cleanPesos(totalInput.value);
    });
  });


  </script>
  
{% endblock %}