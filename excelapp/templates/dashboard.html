{% extends "base.html" %}
{% load humanize %}
{% block content %}
<h2>Dashboard de Proveedor</h2>

<!-- Formulario de Filtros -->
<div class="card mb-4">
  <div class="card-header">
      <h5>Filtros</h5>
  </div>
  <div class="card-body">
      <form method="get" id="filterForm">
          <div class="row">
              <div class="col-md-3">
                  <label for="filtroProveedor" class="form-label">Proveedor:</label>
                  <select id="filtroProveedor" name="proveedor" class="form-select">
                      <option value="">-- Todos --</option>
                      {% for prov in proveedores %}
                          <option value="{{ prov }}" {% if prov == proveedor_filtrado %}selected{% endif %}>{{ prov }}</option>
                      {% endfor %}
                  </select>
              </div>
              <div class="col-md-2">
                  <label for="fechaInicio" class="form-label">Fecha Inicio:</label>
                  <input type="date" id="fechaInicio" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
              </div>
              <div class="col-md-2">
                  <label for="fechaFin" class="form-label">Fecha Fin:</label>
                  <input type="date" id="fechaFin" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
              </div>
              <div class="col-md-2">
                <label for="filtroIdFactura" class="form-label">ID Factura:</label>
                <input type="text" name="id_factura" id="filtroIdFactura" class="form-control" 
                       placeholder="Ej: F-001" value="{{ id_factura_filtrado }}">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary me-2">Filtrar</button>
                  <button type="button" id="limpiarFiltros" class="btn btn-secondary">Limpiar</button>
              </div>
          </div>
      </form>
  </div>
</div>

<!-- Panel de KPI -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Total Facturado</h5>
                <h3 class="card-text">${{ total_facturado|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Total Abonado</h5>
                <h3 class="card-text">${{ total_abonado|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white mb-4">
            <div class="card-body">
                <h5 class="card-title">Porcentaje de Abono</h5>
                <h3 class="card-text">{{ porcentaje_abono|floatformat:2 }}%</h3>
            </div>
        </div>
    </div>
</div>

<!-- Gráfica de KPI - Porcentaje de Abono -->
<div class="card mb-4">
    <div class="card-header">
        <h5>KPI - Porcentaje de Facturación vs Abono</h5>
    </div>
    <div class="card-body">
        <canvas id="kpiChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- Gráfica de Evolución Temporal -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Evolución Temporal de Facturación y Abonos</h5>
    </div>
    <div class="card-body">
        <canvas id="evolucionTemporalChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- Gráficas existentes -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Distribución de Facturas por Proveedor</h5>
    </div>
    <div class="card-body">
        <canvas id="facturasChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Distribución de Abonos por Proveedor</h5>
    </div>
    <div class="card-body">
        <canvas id="abonosChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Saldos por Proveedor</h5>
    </div>
    <div class="card-body">
        <canvas id="saldosChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Evolución de Facturas por Mes (Todos los Proveedores)</h5>
    </div>
    <div class="card-body">
        <canvas id="lineaChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Evolución de Facturas por Mes (Desglose por Proveedor)</h5>
    </div>
    <div class="card-body">
        <canvas id="lineaFacturasChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Evolución de Abonos por Mes (Desglose por Proveedor)</h5>
    </div>
    <div class="card-body">
        <canvas id="lineaAbonosChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const proveedores = {{ proveedores|safe }};
  const facturas = {{ facturas|safe }};
  const abonos = {{ abonos|safe }};
  const saldos = {{ saldos|safe }};
  const proveedoresFiltrados = {{ proveedores_filtrados|safe }};
  const meses = {{ meses|safe }};
  const facturasLinea = {{ facturas_linea|safe }};
  const proveedorFiltrado = "{{ proveedor_filtrado }}";
  const abonosLinea = {{ abonos_linea|safe }};
  
  // Nuevos datos para las gráficas
  const totalFacturado = {{ total_facturado }};
  const totalAbonado = {{ total_abonado }};
  const porcentajeAbono = {{ porcentaje_abono|stringformat:"0.2f"  }};
  const facturasPorMesTotales = {{ facturas_por_mes_totales|safe }};
  const abonosPorMesTotales = {{ abonos_por_mes_totales|safe }};

  // Función para limpiar filtros
  document.getElementById('limpiarFiltros').addEventListener('click', function() {
    document.getElementById('filtroProveedor').value = '';
    document.getElementById('fechaInicio').value = '';
    document.getElementById('fechaFin').value = '';
    document.getElementById('id_factura').value = '';
    document.getElementById('filterForm').submit();
  });

  // Gráfica de KPI - Porcentaje de Abono
  new Chart(document.getElementById('kpiChart'), {
    type: 'doughnut',
    data: {
      labels: ['Facturado', 'Abonado'],
      datasets: [{
        data: [totalFacturado, totalAbonado],
        backgroundColor: ['#4e73df', '#1cc88a'],
        hoverBackgroundColor: ['#2e59d9', '#17a673'],
        hoverBorderColor: "rgba(234, 236, 244, 1)",
      }]
    },
    options: {
      maintainAspectRatio: false,
      tooltips: {
        backgroundColor: "rgb(255,255,255)",
        bodyFontColor: "#858796",
        borderColor: '#dddfeb',
        borderWidth: 1,
        xPadding: 15,
        yPadding: 15,
        displayColors: false,
        caretPadding: 10,
        callbacks: {
          label: function(tooltipItem, data) {
            const value = data.datasets[0].data[tooltipItem.index];
            const label = data.labels[tooltipItem.index] || '';
            return label + ': $' + value.toLocaleString('es-CO', {minimumFractionDigits: 2});
          }
        }
      },
      legend: {
        display: true,
        position: 'bottom'
      },
      cutout: '80%',
    },
    plugins: [{
      beforeDraw: function(chart) {
        const width = chart.width;
        const height = chart.height;
        const ctx = chart.ctx;
        ctx.restore();
        const fontSize = (height / 114).toFixed(2);
        ctx.font = fontSize + "em sans-serif";
        ctx.textBaseline = "middle";
        const text = porcentajeAbono.toFixed(2) + "%";
        const textX = Math.round((width - ctx.measureText(text).width) / 2);
        const textY = height / 2;
        ctx.fillText(text, textX, textY);
        ctx.save();
      }
    }]
  });

  // Gráfica de Evolución Temporal
  new Chart(document.getElementById('evolucionTemporalChart'), {
    type: 'line',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Facturación Total',
          data: facturasPorMesTotales,
          borderColor: '#4e73df',
          backgroundColor: 'rgba(78, 115, 223, 0.05)',
          pointRadius: 3,
          pointBackgroundColor: '#4e73df',
          pointBorderColor: '#4e73df',
          pointHoverRadius: 3,
          pointHoverBackgroundColor: '#4e73df',
          pointHoverBorderColor: '#4e73df',
          pointHitRadius: 10,
          pointBorderWidth: 2,
          fill: true,
          tension: 0.3
        },
        {
          label: 'Abonos Total',
          data: abonosPorMesTotales,
          borderColor: '#1cc88a',
          backgroundColor: 'rgba(28, 200, 138, 0.05)',
          pointRadius: 3,
          pointBackgroundColor: '#1cc88a',
          pointBorderColor: '#1cc88a',
          pointHoverRadius: 3,
          pointHoverBackgroundColor: '#1cc88a',
          pointHoverBorderColor: '#1cc88a',
          pointHitRadius: 10,
          pointBorderWidth: 2,
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      maintainAspectRatio: false,
      scales: {
        x: {
          grid: {
            display: false
          }
        },
        y: {
          ticks: {
            beginAtZero: true,
            callback: function(value) {
              return '$' + value.toLocaleString('es-CO');
            }
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              label += '$' + context.raw.toLocaleString('es-CO', {minimumFractionDigits: 2});
              return label;
            }
          }
        }
      }
    }
  });

  // Gráficos de barras existentes
  new Chart(document.getElementById('facturasChart'), {
    type: 'bar',
    data: {
      labels: proveedores,
      datasets: [{ 
        label: 'Total Facturas', 
        data: facturas, 
        backgroundColor: '#4e73df' 
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString('es-CO');
            }
          }
        }
      }
    }
  });

  new Chart(document.getElementById('abonosChart'), {
    type: 'bar',
    data: {
      labels: proveedores,
      datasets: [{ 
        label: 'Total Abonos', 
        data: abonos, 
        backgroundColor: '#1cc88a' 
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString('es-CO');
            }
          }
        }
      }
    }
  });

  new Chart(document.getElementById('saldosChart'), {
    type: 'pie',
    data: {
      labels: proveedores,
      datasets: [{
        label: 'Saldo',
        data: saldos,
        backgroundColor: [
          '#f6c23e', '#e74a3b', '#36b9cc', '#858796',
          '#5a5c69', '#20c997', '#6610f2'
        ]
      }]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              if (label) {
                label += ': ';
              }
              label += '$' + context.raw.toLocaleString('es-CO', {minimumFractionDigits: 2});
              return label;
            }
          }
        }
      }
    }
  });

  // Gráfico de línea evolución temporal
  const ctxLinea = document.getElementById('lineaChart').getContext('2d');

  // Filtrar datos para el proveedor seleccionado o todos
  let datasetsLinea = [];
  if (proveedorFiltrado && proveedorFiltrado !== '') {
    const provData = facturasLinea.find(f => f.proveedor === proveedorFiltrado);
    if (provData) {
      datasetsLinea.push({
        label: provData.proveedor,
        data: provData.datos,
        fill: false,
        borderColor: '#3874ff',
        tension: 0.1
      });
    }
  } else {
    // Mostrar todos los proveedores
    const colores = ['#3874ff', '#20c997', '#f6c23e', '#e74a3b', '#36b9cc', '#858796', '#6610f2'];
    facturasLinea.forEach((f, i) => {
      datasetsLinea.push({
        label: f.proveedor,
        data: f.datos,
        fill: false,
        borderColor: colores[i % colores.length],
        tension: 0.1
      });
    });
  }

  new Chart(ctxLinea, {
    type: 'line',
    data: {
      labels: meses,
      datasets: datasetsLinea
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      plugins: {
        title: {
          display: true,
          text: 'Evolución de Facturas por Mes'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => '$' + value.toLocaleString('es-CO')
          }
        }
      }
    }
  });

  function generarDatasetLinea(data, labelPrefix, colores) {
    let datasets = [];
    if (proveedorFiltrado && proveedorFiltrado !== '') {
      const provData = data.find(f => f.proveedor === proveedorFiltrado);
      if (provData) {
        datasets.push({
          label: labelPrefix + provData.proveedor,
          data: provData.datos,
          fill: false,
          borderColor: colores[0],
          tension: 0.1
        });
      }
    } else {
      data.forEach((f, i) => {
        datasets.push({
          label: labelPrefix + f.proveedor,
          data: f.datos,
          fill: false,
          borderColor: colores[i % colores.length],
          tension: 0.1
        });
      });
    }
    return datasets;
  }

  const coloresFacturas = ['#3874ff', '#20c997', '#f6c23e', '#e74a3b', '#36b9cc', '#858796', '#6610f2'];
  const coloresAbonos = ['#1cc88a', '#ff6384', '#4bc0c0', '#ff9f40', '#9966ff', '#ffcd56', '#36a2eb'];

  new Chart(document.getElementById('lineaFacturasChart'), {
    type: 'line',
    data: {
      labels: meses,
      datasets: generarDatasetLinea(facturasLinea, 'Facturas - ', coloresFacturas)
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Evolución de Facturas por Mes' }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: value => '$' + value.toLocaleString('es-CO') }
        }
      }
    }
  });

  new Chart(document.getElementById('lineaAbonosChart'), {
    type: 'line',
    data: {
      labels: meses,
      datasets: generarDatasetLinea(abonosLinea, 'Abonos - ', coloresAbonos)
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Evolución de Abonos por Mes' }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: value => '$' + value.toLocaleString('es-CO') }
        }
      }
    }
  });

  // Evento cambio filtro proveedor
  document.getElementById('filtroProveedor').addEventListener('change', function() {
    const prov = this.value;
    const url = new URL(window.location.href);
    if(prov) {
      url.searchParams.set('proveedor', prov);
    } else {
      url.searchParams.delete('proveedor');
    }
    window.location.href = url.toString();
  });
</script>
{% endblock %}